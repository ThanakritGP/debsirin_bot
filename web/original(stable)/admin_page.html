<!-- ===== LOGIN SECTION ===== -->
<div id="login-section" class="login-full-page">
  <div class="login-container">
    <div class="logo-section text-center mb-4">
      <img src="https://raw.githubusercontent.com/ThanakritGP/images/refs/heads/main/DCAS_LOGO_OWO.png"
           alt="DCAS Logo" style="max-width:150px;">
      <h1 class="h4 mt-2">เข้าสู่ระบบผู้ดูแลระบบ</h1>
      <p class="text-muted">กรุณากรอกข้อมูลเพื่อเข้าถึง Dashboard</p>
    </div>

    <form id="loginForm">
      <div class="mb-3 text-start">
        <label for="username" class="form-label">ชื่อผู้ใช้</label>
        <input type="text" id="username" class="form-control" required>
      </div>

      <div class="mb-3 text-start">
        <label for="password" class="form-label">รหัสผ่าน</label>
        <input type="password" id="password" class="form-control" required>
      </div>

      <button type="submit" class="btn btn-primary w-100">เข้าสู่ระบบ</button>
    </form>
  </div>
</div>

<!-- ===== DASHBOARD SECTION ===== -->
<div id="dashboard-section" style="display:none;">
  <!-- TOPBAR -->
  <div class="admin-topbar d-flex justify-content-between align-items-center px-4">
    <div class="fw-semibold">
      <i class="fas fa-user-circle me-2"></i>
      <span id="admin-welcome-text">ยินดีต้อนรับ</span>
    </div>
    <button class="btn btn-outline-danger btn-sm" onclick="logoutAdmin()">
      <i class="fas fa-sign-out-alt me-1"></i> ออกจากระบบ
    </button>
  </div>

  <div class="container-fluid py-4">

    <!-- METRICS -->
    <div class="row mb-3" id="metrics-row">
      <div class="col-12 text-center text-muted">กำลังโหลดสถิติ...</div>
    </div>

    <!-- TABLE -->
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0 text-start">
          <i class="fas fa-table me-2"></i>ข้อมูลนักเรียนทั้งหมด
        </h5>
      </div>
      <div class="card-body">
        <div id="all-students-table-container" class="table-responsive">
          <p class="text-center text-muted">กำลังโหลดข้อมูลตาราง...</p>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ================= GLOBAL SAFE ================= */
window.ALL_STUDENT_SHEET_NAMES =
  window.ALL_STUDENT_SHEET_NAMES ||
  JSON.parse('<?!= ALL_STUDENT_SHEET_NAMES_JSON ?>');

window.__ADMIN_METRICS_LOADED__ =
  window.__ADMIN_METRICS_LOADED__ || false;

/* ================= METRICS ================= */
function loadMetrics() {
  if (window.__ADMIN_METRICS_LOADED__) return;
  window.__ADMIN_METRICS_LOADED__ = true;

  const row = document.getElementById('metrics-row');
  row.innerHTML = `
    <div class="col-md-4 mb-3">
      <div class="metric-card primary">
        <div class="metric-icon"><i class="fas fa-users"></i></div>
        <div><h6>นักเรียนทั้งหมด</h6><div id="total-students">-</div></div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="metric-card success">
        <div class="metric-icon"><i class="fas fa-user-check"></i></div>
        <div><h6>ยืนยันแล้ว</h6><div id="verified-students">-</div></div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="metric-card warning">
        <div class="metric-icon"><i class="fas fa-user-clock"></i></div>
        <div><h6>ยังไม่ยืนยัน</h6><div id="unverified-students">-</div></div>
      </div>
    </div>
  `;

  google.script.run
    .withSuccessHandler(d => {
      // ถ้าไม่ได้อยู่ในโหมด admin แล้ว → ไม่ทำอะไร
      if (!document.body.classList.contains('admin-view')) return;

      const total = document.getElementById('total-students');
      const verified = document.getElementById('verified-students');
      const unverified = document.getElementById('unverified-students');

      if (!total || !verified || !unverified) return;

      total.innerText = d.total + ' คน';
      verified.innerText = d.verified + ' คน';
      unverified.innerText = d.unverified + ' คน';
    })
    .getAdminMetrics();
}

/* ================= TABLE ================= */
function loadAllStudentsTable() {
  const c = document.getElementById('all-students-table-container');
  c.innerHTML = `<div class="text-center"><div class="spinner-border"></div></div>`;

  google.script.run
    .withSuccessHandler(r => {
      c.innerHTML = `<table id="studentsTable" class="table table-striped"></table>`;

      if ($.fn.DataTable.isDataTable('#studentsTable')) {
        $('#studentsTable').DataTable().destroy();
      }

      $('#studentsTable').DataTable({
        data: r.data,
        columns: r.headers.map(h => ({ title: h })),
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        language: {
          search: "ค้นหา:",
          lengthMenu: "แสดง _MENU_ แถว",
          info: "แสดง _START_ ถึง _END_ จากทั้งหมด _TOTAL_ รายการ",
          paginate: {
            previous: "ก่อนหน้า",
            next: "ถัดไป"
          }
        },
        dom: `
          <"d-flex justify-content-between align-items-center mb-2"
            l
            f
          >
          t
          <"d-flex justify-content-between align-items-center mt-2"
            i
            p
          >
        `
      });
    })
    .getAllStudentData();
}

/* ================= LOGIN ================= */
window.loginForm = document.getElementById('loginForm');

if (window.loginForm && !window.loginForm.dataset.bound) {
  window.loginForm.dataset.bound = "true";

  window.loginForm.addEventListener('submit', function (e) {
    e.preventDefault();

    const u = document.getElementById('username');
    const p = document.getElementById('password');
    if (!u || !p) return;

    Swal.fire({
      title: 'กำลังตรวจสอบ...',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => Swal.showLoading()
    });

    google.script.run
      .withSuccessHandler(handleAdminLoginResponse)
      .withFailureHandler(err => {
        Swal.fire('ผิดพลาด', err, 'error');
      })
      .checkAdminCredentials(u.value, p.value);
  });
}

/* ================= UI HELPERS ================= */
function updateAdminTopbar(name) {
  const el = document.getElementById('admin-welcome-text');
  if (!el) {
    console.warn('admin-welcome-text not found');
    return;
  }
  el.innerText = `ยินดีต้อนรับ, คุณ ${name}`;
}

function logoutAdmin() {
  // 1. ทำลาย DataTable ถ้ามี
  if ($.fn.DataTable.isDataTable('#studentsTable')) {
    $('#studentsTable').DataTable().destroy();
  }

  // 2. reset flag
  window.__ADMIN_METRICS_LOADED__ = false;

  // 3. ล้างโหมด Admin
  document.body.classList.remove('admin-view');

  // 4. ล้างหน้า Admin ออกทั้งหมด
  const area = document.getElementById('dynamic-content-area');
  area.innerHTML = '';
  area.classList.add('container');
  area.style.padding = '';
  area.style.margin = '';

  // 5. กลับหน้า Main Page จริง ๆ
  loadMainPage();
}
</script>