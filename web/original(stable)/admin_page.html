<!-- ===== LOGIN SECTION ===== -->
<div id="login-section" class="login-full-page">
  <div class="login-container">
    <div class="logo-section text-center mb-4">
      <img src="https://raw.githubusercontent.com/ThanakritGP/images/refs/heads/main/DCAS_LOGO_OWO.png"
           alt="DCAS Logo" style="max-width:150px;">
      <h1 class="h4 mt-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h1>
      <p class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Dashboard</p>
    </div>

    <form id="loginForm">
      <div class="mb-3 text-start">
        <label for="username" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
        <input type="text" id="username" class="form-control" required>
      </div>

      <div class="mb-3 text-start">
        <label for="password" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input type="password" id="password" class="form-control" required>
      </div>

      <button type="submit" class="btn btn-primary w-100">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </form>
  </div>
</div>

<!-- ===== DASHBOARD SECTION ===== -->
<div id="dashboard-section" style="display:none;">
  <!-- TOPBAR -->
  <div class="admin-topbar d-flex justify-content-between align-items-center px-4">
    <div class="fw-semibold">
      <i class="fas fa-user-circle me-2"></i>
      <span id="admin-welcome-text">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</span>
    </div>
    
    <div class="d-flex gap-2">
      <button class="btn btn-outline-danger btn-sm" onclick="goBackToMain()">
        <i class="fas fa-home me-1"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
      </button>

      <button class="btn btn-outline-danger btn-sm" onclick="logoutAdmin()">
        <i class="fas fa-sign-out-alt me-1"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </div>
  </div>

  <div class="container-fluid py-4">

    <!-- METRICS -->
    <div class="row mb-3" id="metrics-row">
      <div class="col-12 text-center text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</div>
    </div>

    <!-- TABLE -->
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0 text-start">
          <i class="fas fa-table me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </h5>
      </div>
      <div class="card-body">
        <div id="all-students-table-container" class="table-responsive">
          <p class="text-center text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á...</p>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ================= GLOBAL SAFE ================= */
window.ALL_STUDENT_SHEET_NAMES =
  window.ALL_STUDENT_SHEET_NAMES ||
  JSON.parse('<?!= ALL_STUDENT_SHEET_NAMES_JSON ?>');

window.__ADMIN_METRICS_LOADED__ =
  window.__ADMIN_METRICS_LOADED__ || false;

/* ================= METRICS ================= */
function loadMetrics() {
  if (window.__ADMIN_METRICS_LOADED__) return;
  window.__ADMIN_METRICS_LOADED__ = true;

  const row = document.getElementById('metrics-row');
  row.innerHTML = `
    <div class="col-md-4 mb-3">
      <div class="metric-card primary">
        <div class="metric-icon"><i class="fas fa-users"></i></div>
        <div><h6>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6><div id="total-students">-</div></div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="metric-card success">
        <div class="metric-icon"><i class="fas fa-user-check"></i></div>
        <div><h6>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h6><div id="verified-students">-</div></div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="metric-card warning">
        <div class="metric-icon"><i class="fas fa-user-clock"></i></div>
        <div><h6>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h6><div id="unverified-students">-</div></div>
      </div>
    </div>
  `;

  google.script.run
    .withSuccessHandler(d => {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î admin ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
      if (!document.body.classList.contains('admin-view')) return;

      const total = document.getElementById('total-students');
      const verified = document.getElementById('verified-students');
      const unverified = document.getElementById('unverified-students');

      if (!total || !verified || !unverified) return;

      total.innerText = d.total + ' ‡∏Ñ‡∏ô';
      verified.innerText = d.verified + ' ‡∏Ñ‡∏ô';
      unverified.innerText = d.unverified + ' ‡∏Ñ‡∏ô';
    })
    .getAdminMetrics();
}

/* ================= TABLE ================= */
function loadAllStudentsTable() {
  const c = document.getElementById('all-students-table-container');
  c.innerHTML = `<div class="text-center"><div class="spinner-border"></div></div>`;

  google.script.run
    .withSuccessHandler(r => {
      c.innerHTML = `<table id="studentsTable" class="table table-striped"></table>`;

      if ($.fn.DataTable.isDataTable('#studentsTable')) {
        $('#studentsTable').DataTable().destroy();
      }

      const table = $('#studentsTable').DataTable({
        data: r.data,
        columns: r.headers.map(h => ({ title: h })),
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        language: {
          search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:",
          lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡πÅ‡∏ñ‡∏ß",
          info: "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
          paginate: {
            previous: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤",
            next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"
          }
        },
        dom: `
          <"d-flex justify-content-between align-items-center mb-2"
            l
            f
          >
          t
          <"d-flex justify-content-between align-items-center mt-2"
            i
            p
          >
        `,
        responsive: true,
        autoWidth: false
      });

        setTimeout(() => {
        table.columns.adjust().draw(false);
      }, 150);
    })
    .getAllStudentData();
}

/* ================= LOGIN ================= */
window.loginForm = document.getElementById('loginForm');

if (window.loginForm && !window.loginForm.dataset.bound) {
  window.loginForm.dataset.bound = "true";

  window.loginForm.addEventListener('submit', function (e) {
    e.preventDefault();

    const u = document.getElementById('username');
    const p = document.getElementById('password');
    if (!u || !p) return;

    Swal.fire({
      title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => Swal.showLoading()
    });

    google.script.run
      .withSuccessHandler(handleAdminLoginResponse)
      .withFailureHandler(err => {
        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err, 'error');
      })
      .checkAdminCredentials(u.value, p.value);
  });
}

/* ================= UI HELPERS ================= */
function updateAdminTopbar(name) {
  const el = document.getElementById('admin-welcome-text');
  if (!el) {
    console.warn('admin-welcome-text not found');
    return;
  }
  el.innerText = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ‡∏Ñ‡∏∏‡∏ì ${name}`;
}

function logoutAdmin() {

  const token = localStorage.getItem('adminToken'); // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

  if (token) {
    google.script.run.revokeAdminToken(token);
  }

  // üî• ‡∏•‡∏ö token ‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á
  localStorage.removeItem('adminToken');
  sessionStorage.removeItem('adminToken');

  // üî• reset state
  window.__ADMIN_METRICS_LOADED__ = false;

  // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å admin view
  document.body.classList.remove('admin-view');

  const area = document.getElementById('dynamic-content-area');
  area.innerHTML = '';
  area.className = 'container';

  loadMainPage();
}

function resetAdminUI() {
  // 1. Destroy DataTable
  if ($.fn.DataTable.isDataTable('#studentsTable')) {
    $('#studentsTable').DataTable().destroy();
    $('#studentsTable').empty();
  }

  // 2. Reset flag
  window.__ADMIN_METRICS_LOADED__ = false;

  // 3. ‡∏•‡∏ö class admin ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  document.body.classList.remove('admin-view');

  // 4. ‡∏•‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ admin ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM
  const adminSection = document.getElementById('dashboard-section');
  if (adminSection) adminSection.remove();

  const loginSection = document.getElementById('login-section');
  if (loginSection) loginSection.remove();
}

function goBackToMain() {
  resetAdminUI();   // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  loadMainPage();   // ‡πÇ‡∏´‡∏•‡∏î main ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö clean
}
</script>